---
title: "decoupleR_pathway_enrichment_analysis"
author: "Dustin Schilling"
date: "17 5 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Library 
```{r}
library(readr)
library(readxl)
library(cosmosR)
library(decoupleR)
library(dplyr)
library(tidyr)
library(tibble)
```


# Input Data

```{r}
logFC_proteomics_z <- readRDS("../results/logFC_proteomics_z.Rda")
logFC_metabolomics_z <- readRDS("../results/logFC_metabolomics_z.Rda")

combined_metab_gene_hallmarks <- read_csv("../support/combined_metab_gene_hallmarks.csv")

Biocrates_metabolite_identifier <- read_excel("../support/Biocrates_metabolite_identifier.xlsx")
Biocrates_metabolite_identifier$feature <- gsub("[()/: -]",".",Biocrates_metabolite_identifier$feature)


network_combined <- combined_metab_gene_hallmarks
network_combined$mor <- 1
network_combined$term <- gsub("HALLMARK_","", network_combined$term)
network_combined$term <- gsub("_", " ", network_combined$term)

##################################
# limma ttest
##################################
proteomics_t <- readRDS("../results/proteomics_DE_t.Rda")
metabolomics_t <- readRDS("../results/metabolomics_DE_t.Rda")

proteomics_t <- proteomics_t[,c(3,6 )]
proteomics_t <- proteomics_t[-which(proteomics_t$ID == "NA"),]
proteomics_t<- unique(proteomics_t)
proteomics_t <- proteomics_t %>%
  group_by(ID) %>%
  summarise_each(funs(mean))
proteomics_t <- proteomics_t %>%
  drop_na() %>%
  column_to_rownames("ID") %>%
  as.matrix() 


metabolomics_t <- metabolomics_t[,c(12, 5)] 
metabolomics_t<- unique(metabolomics_t)
metabolomics_t <- metabolomics_t %>%
  group_by(HMDB) %>%
  summarise_each(funs(mean))
metabolomics_t <- metabolomics_t %>%
  drop_na() %>%
  column_to_rownames("HMDB") %>%
  as.matrix() 

combined_t <- rbind(metabolomics_t, proteomics_t)
```

# Data preparation
```{r}
#################################################
## metab
#################################################
metab_decoupler_z <- logFC_metabolomics_z %>%
  rownames_to_column(var= "ID")
metab_decoupler_z <- merge(metab_decoupler_z, Biocrates_metabolite_identifier, by.x = "ID", by.y = "feature")
metab_decoupler_z <- metab_decoupler_z[,-c(12:14)]

metab_decoupler_z <- metab_decoupler_z %>%
  mutate(HMDB = strsplit(as.character(HMDB), "/")) %>%
  unnest(HMDB) %>%
  filter(HMDB != "") %>%
  unique()

# average if metabolites have same HMDB number
# so there is only one HMDB as input
metab_decoupler_z <- metab_decoupler_z[,c(12,2:11)]
metab_decoupler_z <- metab_decoupler_z %>%
  group_by(HMDB) %>%
  summarise_each(funs(mean))
# now rownames can be annotated
metab_decoupler_z <- metab_decoupler_z %>%
  column_to_rownames("HMDB")
# NAs needs to be removed and input in matrix form
metab_decoupler_z <- metab_decoupler_z %>%
  drop_na() %>%
  as.matrix()
colnames(metab_decoupler_z) <- paste("Patient", colnames(metab_decoupler_z), sep ="_")


#################################################
## prot
#################################################
prot_decoupler_z <- logFC_proteomics_z %>%
  drop_na() %>%
  as.matrix()
colnames(prot_decoupler_z) <- paste("Patient", colnames(prot_decoupler_z), sep ="_")

#################################################
## combination
#################################################


combined_mat_z <- rbind(prot_decoupler_z, metab_decoupler_z)



##### Do the NA's cause problems -> drop_NA() commands deletes a lot of rows (HMDB, proteins)
##### Is there another approach to this?







```


# norm_wmean on single patient level
```{r}
res_wmean_PEA_sp <-  run_wmean(mat = combined_mat_z, net = network_combined, .source = "term", .target = "feature", .mor="mor")
res_wmean_PEA_sp <- res_wmean_PEA_sp %>%
  filter(statistic == 'norm_wmean')
```


# norm_wmean on DE genes
```{r}
res_wmean_PEA <-  run_wmean(mat = combined_t, net = network_combined, .source = "term", .target = "feature", .mor="mor")
res_wmean_PEA <- res_wmean_PEA %>%
  filter(statistic == 'norm_wmean')
```



